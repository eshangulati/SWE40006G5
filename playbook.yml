---
- name: Prepare Servers for Docker Deployment
  hosts: all
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3  # Ensures Python 3 is used

  tasks:
    - name: Install Docker on AWS Linux using dnf
      dnf:
        name: docker
        state: latest
      when: ansible_os_family == "RedHat"

    - name: Start and enable Docker service
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Add user to Docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Ensure Python 3 and pip3 are installed
      dnf:
        name:
          - python3
          - python3-pip
        state: present

    - name: Upgrade pip to the latest version
      pip:
        name: pip
        state: latest
        executable: pip3

    - name: Install Docker SDK for Python
      pip:
        name: docker
        executable: pip3

    - name: Pull latest Docker image
      docker_image:
        name: "buffy1809/myapp"
        tag: "latest"
        source: pull

    - name: Remove existing Docker container
      docker_container:
        name: myapp
        state: absent

    - name: Create Docker container
      docker_container:
        name: myapp
        image: "buffy1809/myapp:latest"
        state: started
        recreate: yes
        published_ports:
          - "{{ item }}"
      with_items:
        - "80:80"  # For testing server
        - "8081:80"  # For production server
